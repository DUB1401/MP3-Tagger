# Разработка парсера
Разработка модуля парсера для Melon максимально упрощена, унифицирована и абстрагирована. Пройдите этот путь вместе с данным мануалом.

## Инструкция
### 0. Определения
Для лучшего понимания терминологии Melon рекомендуется ознакомиться с основными определениями, введёнными в процесс разработки.

| **Термин**                 | **Определение**                                                                                                                                                         |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Временный каталог парсера  | Директория с относительным путём `Temp/[PARSER_NAME]`. Используется для хранения временных файлов, необходимых парсеру, или загрузки изображений без спецификации пути. |
| Домашний каталог парсера   | Директория с относительным путём `Parsers/[PARSER_NAME]`. Также под этим может пониматься корень подмодуля Git.                                                         |
| Дополнение контента        | Процесс получения и записи в структуры описания глав контента (слайдов или абзацев).                                                                                    |
| Формат описательного файла | Набор правил о заполняемых ключах и типах их значений в описательном файле. Подробнее [здесь](/Docs/Examples).                                                          |
| Коллекция                  | Текстовый файл _Collection.txt_ во временном каталоге парсера, содержащий список алиасов тайтлов, разделённых символом новой строки.                                    |
| Описательный файл          | Файл с расширением JSON, содержащий в себе все данные о конкретном тайтле в соответствии с одним из поддерживаемых форматов.                                            |

### 1. Базовые файлы
Домашний каталог парсера обязан содержать следующие файлы:
* **main.py** – главный модуль и точка входа в парсер;
* **README.md** – описание дополнительных настроек парсера и особенностей использования;
* **requirements.txt** – если парсер имеет специфические зависимости PyPI, не определённые в [dublib](https://github.com/DUB1401/dublib/blob/main/pyproject.toml) или [Melon](https://github.com/Otaku-Melons/Melon/blob/main/requirements.txt), укажите их здесь.

Опциональны следующие файлы:
* **.gitignore** – игнорируйте кэш Python и другие временные файлы Runtime и разработки;
* **LICENSE** или **LICENSE.txt** – поставляйте лицензию для вашего Open Source модуля, чтобы явно указать все аспекты использования;
* **settings.json** – при необходимости, укажите определите по умолчанию и дополнительные параметры;

### 2. Выбор типа парсера
Melon поддерживает два типа контента: манга и ранобэ.

Воспользуйтесь командой `init` от Melon для автоматической генерации всех необходимых файлов парсера выбранного типа контента. Подробнее: `help init`.

В _main.py_ появится класс **Parser**, у наследованный от соответствующего типа, а также несколько констант. Определите их самостоятельно при необходимости.

```Python
# Версия парсера.
VERSION = "2.0.0"
# Уникальное название парсера. Не должно содержать небуквенных символов.
NAME = "remanga"
# Домен источника без указания протокола.
SITE = "remanga.org"
# Тип контента. Определяется автоматически.
TYPE = Manga
```

В файле _settings.json_ можно указать стандартные параметры или определить дополнительные в секции `custom`. Пожалуйста, не забывайте описывать их в _README.md_.

### 3. Внедрение базового функционала
Для нормального функционирования вам необходимо переопределить методы `amend` и `parse`, при этом не меняя принимаемых ими аргументов. Опционально вы можете имплементировать методы `collect` и `image` по шаблону:

#### collect
```Python
def collect(self, period: int | None = None, filters: str | None = None, pages: int | None = None) -> list[str]:
		"""
		Собирает список тайтлов по заданным параметрам.
			period – количество часов до текущего момента, составляющее период получения данных;\n
			filters – строка, описывающая фильтрацию (подробнее в README.md);\n
			pages – количество запрашиваемых страниц каталога.
		"""

		Collection = list()

		return Collection
```

#### image
```Python
def image(self, url: str) -> str | None:
	"""
	Скачивает изображение с сайта во временный каталог парсера и возвращает имя файла.
		url – ссылка на изображение.
	"""

	Filename = None or str()

	return Filename
```

Хранение данных внутри парсера происходит при помощи абстракции над строго задокументированным форматом JSON соответствующего типа, информацию о котором можно найти [здесь](/Docs/Examples). Доступ осуществляется через наследуемую переменную **self._Title**.

Для выполнения запросов рекомендуется использовать библиотеку [dublib](https://github.com/DUB1401/dublib) и её модуль `WebRequestor`. Вы можете определить собственные параметры запросчика через наследуемый метод **self._InitializeRequestor** по примеру из родительского [объекта](/Source/Core/Base/MangaParser.py)

### 3. Поддержка портов и исключений

Для работы с CLI, логами, временными файлами и настройками предоставляются так называемые порты и объектные имплементации, позволяющие выводить и использовать данные в унифицированном формате. Каждый парсер на разных этапах своей работы может использовать следующие порты:

#### Порты CLI
Доступ к портам CLI осуществляется посредством использования наследуемых методов:
* self._PrintCollectingStatus

#### Порты логов
Доступ к портам логов осуществляется из коллекции системных объектов **self._SystemObjects.logger**.
* Этапы парсинга:
	* amending_end
	* chapter_amended
	* chapter_repaired
	* chapter_skipped
	* collect_filters
	* collect_pages
	* collect_period
	* covers_unstubbed
	* parsing_start
	* titles_collected
* Предупреждения:
	* collect_filters_ignored
	* collect_pages_ignored
	* collect_period_ignored
* Ошибки:
	* request_error
	* title_not_found

Кроме того, доступ к логам можно осуществлять через имплементацию Melon, что позволяет последнему обрабатывать их при помощи файлов конфигурации (см. [Настройка логов](/Docs/LOGGER.md)).
```Python
self._SystemObjects.logger.info("Info")
self._SystemObjects.logger.warning("Warning")
self._SystemObjects.logger.error("Error")
self._SystemObjects.logger.critical("Critical")
```
В некоторых случаях парсер также обязан выбрасывать исключения, которые используются Melon для корректной обработки процесса получения контента.

* ParsingError – во время получения данных тайтла (метод `parse`) возникла ошибка;
* TitleNotFound – тайтл не найден в источнике.

#### Порты временных файлов
Парсеру может понадобиться хранить какие-либо сторонние файлы, тебующиеся обработчику контента (например _Collection.txt_), и, чтобы не засорять домашний каталог, доступен порт для лёгкого получения доступа к директории _Temp_. Для каждого парсера внутри данной директории создаётся свой подраздел.
```Python
from Source.Core.ImagesDownloader import ImagesDownloader

# Получение пути к каталогу временных файлов парсера.
Path = self.__SystemObjects.temper.parser_temp
# Скачивание изображения во временный каталог парсера.
Filename = ImagesDownloader(self._SystemObjects).temp_image("https://link_to_image")
# Очистка каталога временных файлов парсера.
self._SystemObjects.temper.clear_parser_temp()
```

#### Настройки
Доступ к настройкам парсера рекомендуется осуществлять через абстракцию `ParserSettings`, однако классический режим также доступен.

```Python
# Классический небезопасный режим.
self._Settings["common"]["delay"]
self._Settings["proxy"]["enabled"]
self._Settings["custom"]["key"]
# Доступ через абстракцию.
self._Settings.common.delay
self._Settings.proxy.enabled
self._Settings.custom["key"]
```

### 4. Рекомендации
Как и любой хороший Open Source проект, Melon имеет ряд рекомендаций по чистоте кода парсеров, а также взаимодействию модулей и их структуре. Следуя им, вы однозначно повысите качество интеграции своего парсера с системой.

| **Номер** | **Описание**                                                                                                                                                                                                     |
|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1         | Парсер должен выполнять все файловые операции внутри своих рабочих директорий, определённых настройками, а также во временном каталоге.                                                                          |
| 2         | Все сетевые запросы парсера должны поддерживать проброс через прокси-сервер. Это позволяет обходить региональные ограничения.                                                                                    |
| 3         | Следует использовать только порты CLI/логов для общения с пользователем для унификации интерфейса.                                                                                                               |
| 4         | Ограничивайте частоту запросов к серверу: это позволяет не только избежать блокировок, но и не создаёт избыточную нагрузку на источник контента, что является хорошим тоном.                                     |
| 5         | Всегда указывайте в описательных файлах авторов и переводчиков, если таковые известны. Уважайте чужой труд.                                                                                                      |
| 6         | Парсер должен опираться на предоставляемые Melon методы, порты, имплементации и абстракции. Это избавляет вас от изобретения велосипеда и позволяет длительное время поддерживать парсер в актуальном состоянии. |
| 7         | Домашний каталог парсера должен являться неизменяемым. Все настройки определяются в `Configs/[PARSER_NAME]`, а временные файлы в `Temp/[PARSER_NAME]`. Поддерживайте чистоту.                                    |

### 5. Работа с парсером
Такие вещи, как CLI, логи, а также работа с данными ложатся на плечи Melon. Он следит за валидностью, стилистикой и иногда корректностью рабочего процесса и выходных данных. Предоставив парсер и правильно его настроив, вы можете использовать его так же непринуждённо, как и встроенные модули.

В случае возникновения вопросов свяжитесь с разработчиком: [@DUB1401](https://github.com/DUB1401).
